<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>City Builder 2</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    background: #eef;
  }
  #topBar {
    background: #333;
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    font-size: 18px;
  }
  #container {
    display: flex;
  }
  #grid {
    display: grid;
    grid-template-columns: repeat(20, 30px);
    grid-template-rows: repeat(15, 30px);
    gap: 1px;
    background: #aaa;
    margin: 10px;
  }
  .cell {
    width: 30px;
    height: 30px;
    background: white;
    text-align: center;
    line-height: 30px;
    font-size: 20px;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  .levelBadge {
    position: absolute;
    bottom: 0;
    right: 2px;
    font-size: 10px;
    background: rgba(0,0,0,0.5);
    color: white;
    padding: 0 3px;
    border-radius: 3px;
  }
  #shop {
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 10px;
    background: #ddf;
    min-width: 150px;
  }
  .button {
    padding: 5px;
    background: #44c;
    color: white;
    cursor: pointer;
    border: none;
    user-select: none;
  }
  .button:hover {
    background: #228;
  }
  /* Popup styling */
  #popupOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.4);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #popup {
    background: white;
    width: 50vw;
    max-width: 400px;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px #0006;
    font-size: 16px;
  }
  #popup h2 {
    margin-top: 0;
  }
  #popup button {
    margin-top: 15px;
    padding: 8px 12px;
    font-size: 16px;
  }
</style>
</head>
<body>
  <div id="topBar">
    <div>ðŸ’µ Money: $<span id="money">1000</span></div>
    <div>ðŸ‘¥ Population: <span id="population">0</span></div>
  </div>
  <div id="container">
    <div id="grid"></div>
    <div id="shop"></div>
  </div>

  <div id="popupOverlay">
    <div id="popup">
      <h2 id="popupTitle"></h2>
      <div id="popupContent"></div>
      <button id="upgradeBtn">Upgrade</button>
      <button id="closePopupBtn" style="margin-left:10px;">Close</button>
    </div>
  </div>

<script>
  const grid = document.getElementById("grid");
  const shop = document.getElementById("shop");
  const moneyDisplay = document.getElementById("money");
  const populationDisplay = document.getElementById("population");
  const popupOverlay = document.getElementById("popupOverlay");
  const popupTitle = document.getElementById("popupTitle");
  const popupContent = document.getElementById("popupContent");
  const upgradeBtn = document.getElementById("upgradeBtn");
  const closePopupBtn = document.getElementById("closePopupBtn");

  let money = 1000;
  let population = 0;
  let selectedBuilding = null;
  let currentCell = null;  // For popup, stores {r, c, cell}

  const rows = 15;
  const cols = 20;
  // gridData[r][c] = { building, level, upgradeCost, income, pop }
  const gridData = Array(rows).fill(null).map(() => Array(cols).fill(null));

  const buildings = [
    { 
      name: "House ðŸ ", cost: 100, pop: 5, income: 0, 
      maxLevel: 3, upgradeBaseCost: 150, upgradePopIncrease: 3, upgradeIncomeIncrease: 0,
      descriptionLevels: [
        "Level 1: Houses 5 people.",
        "Level 2: Houses 8 people.",
        "Level 3: Houses 11 people."
      ]
    },
    { name: "Water ðŸ’§", cost: 150, power: false },
    { name: "Power âš¡", cost: 150, power: true },
    { 
      name: "Factory ðŸ­", cost: 200, income: 25, maxLevel: 3, upgradeBaseCost: 300, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 15,
      descriptionLevels: [
        "Level 1: Produces $25/sec.",
        "Level 2: Produces $40/sec.",
        "Level 3: Produces $55/sec."
      ]
    },
    { 
      name: "Supermarket ðŸ›’", cost: 250, income: 30, maxLevel: 3, upgradeBaseCost: 350, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 20,
      descriptionLevels: [
        "Level 1: Produces $30/sec.",
        "Level 2: Produces $50/sec.",
        "Level 3: Produces $70/sec."
      ]
    },
    { 
      name: "Bank ðŸ¦", cost: 400, income: 50, maxLevel: 3, upgradeBaseCost: 500, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 30,
      descriptionLevels: [
        "Level 1: Produces $50/sec.",
        "Level 2: Produces $80/sec.",
        "Level 3: Produces $110/sec."
      ]
    },
    { 
      name: "Apartment ðŸ¢", cost: 500, pop: 20, income: 10, maxLevel: 3, upgradeBaseCost: 400, 
      upgradePopIncrease: 10, upgradeIncomeIncrease: 10,
      descriptionLevels: [
        "Level 1: Houses 20 people, produces $10/sec.",
        "Level 2: Houses 30 people, produces $20/sec.",
        "Level 3: Houses 40 people, produces $30/sec."
      ]
    },
    { name: "Hospital ðŸ¥", cost: 300 },
    { 
      name: "Cinema ðŸŽ¬", cost: 450, income: 40, maxLevel: 3, upgradeBaseCost: 400, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 25,
      descriptionLevels: [
        "Level 1: Produces $40/sec.",
        "Level 2: Produces $65/sec.",
        "Level 3: Produces $90/sec."
      ]
    },
    { 
      name: "Restaurant ðŸ”", cost: 300, income: 35, maxLevel: 3, upgradeBaseCost: 350, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 20,
      descriptionLevels: [
        "Level 1: Produces $35/sec.",
        "Level 2: Produces $55/sec.",
        "Level 3: Produces $75/sec."
      ]
    },
    { 
      name: "Amusement Park ðŸŽ¢", cost: 1000, income: 100, maxLevel: 3, upgradeBaseCost: 700, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 50,
      descriptionLevels: [
        "Level 1: Produces $100/sec.",
        "Level 2: Produces $150/sec.",
        "Level 3: Produces $200/sec."
      ]
    },
    { 
      name: "Stadium ðŸŸï¸", cost: 1500, income: 150, maxLevel: 3, upgradeBaseCost: 1000, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 70,
      descriptionLevels: [
        "Level 1: Produces $150/sec.",
        "Level 2: Produces $220/sec.",
        "Level 3: Produces $290/sec."
      ]
    },
    { name: "Wind ðŸŒ¬ï¸", cost: 200, power: true },
    { name: "Solar â˜€ï¸", cost: 250, power: true },
    { 
      name: "School ðŸšŒ", cost: 400, income: 40, maxLevel: 3, upgradeBaseCost: 400, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 25,
      descriptionLevels: [
        "Level 1: Produces $40/sec.",
        "Level 2: Produces $65/sec.",
        "Level 3: Produces $90/sec."
      ]
    },
    { 
      name: "Music Store ðŸ¤", cost: 300, income: 35, maxLevel: 3, upgradeBaseCost: 350, 
      upgradePopIncrease: 0, upgradeIncomeIncrease: 20,
      descriptionLevels: [
        "Level 1: Produces $35/sec.",
        "Level 2: Produces $55/sec.",
        "Level 3: Produces $75/sec."
      ]
    }
  ];

  function updateDisplay() {
    moneyDisplay.textContent = money;
    populationDisplay.textContent = population;
  }

  // Create shop buttons
  buildings.forEach((b) => {
    const btn = document.createElement("button");
    btn.textContent = `${b.name} - $${b.cost}`;
    btn.className = "button";
    btn.onclick = () => {
      selectedBuilding = b;
    };
    shop.appendChild(btn);
  });

  // Create grid cells
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.addEventListener("click", () => handleCellClick(r, c, cell));
      grid.appendChild(cell);
    }
  }

  function withinRange(r, c, type) {
    const range = 3;
    for (let i = Math.max(0, r - range); i <= Math.min(rows - 1, r + range); i++) {
      for (let j = Math.max(0, c - range); j <= Math.min(cols - 1, c + range); j++) {
        const b = gridData[i][j];
        if (type === "power" && b?.building?.power) return true;
        if (type === "water" && b?.building?.name === "Water ðŸ’§") return true;
      }
    }
    return false;
  }

  function handleCellClick(r, c, cell) {
    const current = gridData[r][c];

    // If there is a building, open popup for upgrade/info
    if (current) {
      currentCell = { r, c, cell };
      openPopup(current);
      return;
    }

    // Otherwise place a building if one is selected and cell empty
    if (selectedBuilding && !current) {
      if (money < selectedBuilding.cost) {
        alert("Not enough money to build this.");
        return;
      }
      money -= selectedBuilding.cost;
      const newBuilding = {
        building: selectedBuilding,
        level: 1,
        upgradeCost: selectedBuilding.upgradeBaseCost || Math.floor(selectedBuilding.cost * 1.5),
        income: selectedBuilding.income || 0,
        pop: selectedBuilding.pop || 0
      };
      gridData[r][c] = newBuilding;
      updateCellDisplay(cell, newBuilding);
      if (newBuilding.pop) population += newBuilding.pop;
      updateDisplay();
    }
  }

  function updateCellDisplay(cell, buildingData) {
    cell.textContent = buildingData.building.name.split(" ")[1];
    // Remove old level badge if exists
    const oldBadge = cell.querySelector(".levelBadge");
    if (oldBadge) cell.removeChild(oldBadge);

    if (buildingData.level > 1) {
      const badge = document.createElement("div");
      badge.className = "levelBadge";
      badge.textContent = `Lv${buildingData.level}`;
      cell.appendChild(badge);
    }
  }

  // Popup logic
  function openPopup(buildingData) {
    const b = buildingData.building;
    popupTitle.textContent = b.name;
    let contentHtml = `<p>Current Level: ${buildingData.level}</p>`;
    if (b.descriptionLevels) {
      contentHtml += "<p><strong>Upgrade Info:</strong></p><ul>";
      b.descriptionLevels.forEach((desc, i) => {
        contentHtml += `<li${i + 1 === buildingData.level ? ' style="font-weight:bold;"' : ''}>${desc}</li>`;
      });
      contentHtml += "</ul>";
    } else {
      contentHtml += "<p>No upgrade info available.</p>";
    }

    if (b.maxLevel && buildingData.level < b.maxLevel) {
      contentHtml += `<p>Upgrade cost: $${buildingData.upgradeCost}</p>`;
      upgradeBtn.style.display = "inline-block";
      upgradeBtn.disabled = money < buildingData.upgradeCost;
    } else {
      contentHtml += `<p><em>Max level reached.</em></p>`;
      upgradeBtn.style.display = "none";
    }

    popupContent.innerHTML = contentHtml;
    popupOverlay.style.display = "flex";
  }

  upgradeBtn.onclick = () => {
    if (!currentCell) return;
    const { r, c, cell } = currentCell;
    const bData = gridData[r][c];
    if (!bData || !bData.building.maxLevel || bData.level >= bData.building.maxLevel) return;
    if (money < bData.upgradeCost) {
      alert("Not enough money to upgrade!");
      return;
    }
    money -= bData.upgradeCost;
    bData.level++;
    bData.upgradeCost = Math.floor(bData.upgradeCost * 1.8);
    if (bData.building.pop) {
      population += bData.building.upgradePopIncrease;
      bData.pop += bData.building.upgradePopIncrease;
    }
    if (bData.building.income) {
      bData.income += bData.building.upgradeIncomeIncrease;
    }
    updateCellDisplay(cell, bData);
    updateDisplay();
    openPopup(bData); // Refresh popup with updated info
  };

  closePopupBtn.onclick = () => {
    popupOverlay.style.display = "none";
    currentCell = null;
  };

  // Income & population update every second
  setInterval(() => {
    let income = 0;
    population = 0;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        const cellData = gridData[r][c];
        if (cellData) {
          // Only add income if powered and watered (or no requirement for simple buildings)
          if (cellData.income && withinRange(r, c, "power") && withinRange(r, c, "water")) {
            income += cellData.income;
          }
          if (cellData.pop) population += cellData.pop;
        }
      }
    }
    money += income;
    updateDisplay();
  }, 1000);

  updateDisplay();
</script>
</body>
</html>
