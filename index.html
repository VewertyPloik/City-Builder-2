<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>City Builder 2</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #eef2f3;
    margin: 0; padding: 10px;
    user-select: none;
  }
  #topBar {
    margin-bottom: 10px;
    font-size: 18px;
  }
  #topBar span {
    margin-right: 20px;
  }
  #controls {
    margin-bottom: 10px;
  }
  button, select {
    padding: 6px 12px;
    margin-right: 8px;
    font-size: 16px;
    cursor: pointer;
  }
  #grid {
    display: grid;
    grid-template-columns: repeat(32, 24px);
    grid-template-rows: repeat(32, 24px);
    gap: 2px;
    max-width: 800px;
    margin: auto;
    background: #ccc;
    border: 2px solid #999;
  }
  .tile {
    width: 24px;
    height: 24px;
    background: #fff;
    border: 1px solid #bbb;
    font-size: 18px;
    line-height: 24px;
    text-align: center;
    cursor: pointer;
    user-select: none;
  }
  .locked {
    background: #444;
    cursor: not-allowed;
  }
  .popupOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  .popupContent {
    background: white;
    padding: 20px;
    border-radius: 6px;
    width: 300px;
    max-height: 70vh;
    overflow-y: auto;
    box-shadow: 0 0 10px #00000055;
  }
  .popupContent h2 {
    margin-top: 0;
  }
  .popupContent ul {
    list-style: none;
    padding-left: 0;
  }
  .popupContent ul li {
    margin: 6px 0;
  }
</style>
</head>
<body>

<div id="topBar">
  <span>üí∞ Money: $<span id="money">5000</span></span>
  <span>üë• Population: <span id="population">0</span></span>
  <span>‚è≥ Next Paycheck: <span id="paycheckTimer">60</span>s</span>
</div>

<div id="controls">
  <select id="buildingSelect">
    <option value="">-- Select Building --</option>
  </select>
  <button id="deleteBtn">Delete</button>
  <button id="earningsBtn">View Earnings</button>
  <button id="upgradeRangeBtn">Upgrade Range ($500/$1000)</button>
</div>

<div id="grid"></div>

<!-- Earnings popup -->
<div id="earningsPopup" class="popupOverlay" style="display:none;">
  <div class="popupContent">
    <h2>Your Income Sources</h2>
    <ul id="earningsList"></ul>
    <button onclick="closeEarnings()">Close</button>
  </div>
</div>

<script>
  const gridSize = 32;
  let unlockedSize = 16;
  const tileSize = 24;

  let money = 5000;
  let population = 0;
  let paycheckTimer = 60;
  let deleteMode = false;
  let selectedBuilding = "";
  let rangeUpgradeLevel = 1; // affects power/water range: 3,5,10 blocks

  // Define buildings
  const buildingsData = [
    { name: "House", emoji: "üè†", cost: 100, income: [5,10,20], population: [3,5,8] },
    { name: "Supermarket", emoji: "üõí", cost: 200, income: [20,30,50] },
    { name: "Power Plant", emoji: "‚ö°", cost: 300, income: [15,30,50] },
    { name: "Water Tower", emoji: "üíß", cost: 250, income: [10,25,40] },
    { name: "Factory", emoji: "üè≠", cost: 400, income: [25,40,60] },
    { name: "Bank", emoji: "üè¶", cost: 500, income: [50,80,120] },
    { name: "School", emoji: "üöå", cost: 300, income: [30,50,70] },
    { name: "Airport", emoji: "üõ©Ô∏è", cost: 1000, income: [100,150,200] },
    { name: "Hospital", emoji: "üöë", cost: 250, income: [10,20,30] },
    { name: "Subway", emoji: "üöá", cost: 250, income: [15,30,50] },
    { name: "Fire Station", emoji: "üöí", cost: 250, income: [20,30,50] },
    { name: "Music Store", emoji: "üè§", cost: 300, income: [35,50,70] },
    { name: "Apartment", emoji: "üè¢", cost: 1000, income: [60,90,130] },
    { name: "Amusement Park", emoji: "üé¢", cost: 1000, income: [100,140,190] },
    { name: "Gas Station", emoji: "‚õΩÔ∏è", cost: 150, income: [10,20,35] },
    { name: "Mall", emoji: "üè¨", cost: 800, income: [70,100,140] },
    { name: "Office", emoji: "üè¢", cost: 700, income: [60,90,120] },
    { name: "Bar", emoji: "üç∫", cost: 250, income: [30,45,65] },
    { name: "Gym", emoji: "üèãÔ∏è", cost: 300, income: [35,55,80] },
    { name: "Park", emoji: "üå≥", cost: 150, income: [15,25,40] },
  ];

  // The city grid: array of 1024 tiles with {buildingIndex, level} or null
  let cityGrid = new Array(gridSize * gridSize).fill(null);

  const gridDiv = document.getElementById("grid");
  const moneySpan = document.getElementById("money");
  const populationSpan = document.getElementById("population");
  const paycheckSpan = document.getElementById("paycheckTimer");
  const buildingSelect = document.getElementById("buildingSelect");
  const deleteBtn = document.getElementById("deleteBtn");
  const earningsBtn = document.getElementById("earningsBtn");
  const upgradeRangeBtn = document.getElementById("upgradeRangeBtn");
  const earningsPopup = document.getElementById("earningsPopup");
  const earningsList = document.getElementById("earningsList");

  // Initialize grid UI
  function createGrid() {
    gridDiv.innerHTML = "";
    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        const tile = document.createElement("div");
        tile.classList.add("tile");
        if(x >= unlockedSize || y >= unlockedSize){
          tile.classList.add("locked");
          tile.title = "Locked plot - Buy to unlock";
        }
        tile.dataset.pos = y*gridSize + x;
        tile.onclick = () => onTileClick(x,y);
        gridDiv.appendChild(tile);
      }
    }
  }

  // Populate building selector
  function populateBuildingSelect(){
    buildingsData.forEach((b,i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `${b.emoji} ${b.name} ($${b.cost})`;
      buildingSelect.appendChild(opt);
    });
  }

  function onTileClick(x,y){
    const index = y*gridSize + x;
    const tileData = cityGrid[index];

    if(x >= unlockedSize || y >= unlockedSize){
      // Try buy plot
      if(money >= 5000){
        money -= 5000;
        unlockedSize = Math.min(unlockedSize + 4, gridSize);
        updateUI();
        createGrid();
        renderGrid();
      } else {
        alert("Not enough money to unlock plots ($5000 each).");
      }
      return;
    }

    if(deleteMode){
      if(tileData){
        money += buildingsData[tileData.buildingIndex].cost;
        cityGrid[index] = null;
        updateUI();
        renderGrid();
      }
      return;
    }

    if(selectedBuilding === "") {
      alert("Please select a building first.");
      return;
    }

    if(tileData){
      // Upgrade if possible
      if(tileData.level < 3){
        const upgradeCost = buildingsData[tileData.buildingIndex].cost * tileData.level;
        if(money >= upgradeCost){
          money -= upgradeCost;
          tileData.level++;
          updateUI();
          renderGrid();
        } else {
          alert("Not enough money to upgrade building.");
        }
      } else {
        alert("Building is already at max level.");
      }
    } else {
      // Place building
      const building = buildingsData[selectedBuilding];
      if(money >= building.cost){
        money -= building.cost;
        cityGrid[index] = { buildingIndex: selectedBuilding, level: 1 };
        updateUI();
        renderGrid();
      } else {
        alert("Not enough money to build.");
      }
    }
  }

  // Calculate population based on houses with power and water nearby
  function calculatePopulation(){
    let pop = 0;
    cityGrid.forEach((tile, index) => {
      if(tile){
        const building = buildingsData[tile.buildingIndex];
        if(building.name === "House"){
          if(hasPowerAndWater(index, tile.level)){
            pop += building.population[tile.level - 1];
          }
        }
      }
    });
    return pop;
  }

  // Check if house has power and water within range (Manhattan distance)
  function hasPowerAndWater(index, level){
    const range = rangeUpgradeLevel === 1 ? 3 : rangeUpgradeLevel === 2 ? 5 : 10;
    const x = index % gridSize;
    const y = Math.floor(index / gridSize);

    let powerNearby = false;
    let waterNearby = false;

    for(let dy = -range; dy <= range; dy++){
      for(let dx = -range; dx <= range; dx++){
        const nx = x + dx;
        const ny = y + dy;
        if(nx < 0 || ny < 0 || nx >= gridSize || ny >= gridSize) continue;
        const nIndex = ny*gridSize + nx;
        const neighbor = cityGrid[nIndex];
        if(neighbor){
          const b = buildingsData[neighbor.buildingIndex].name;
          if(b === "Power Plant" && Math.abs(dx)+Math.abs(dy) <= range) powerNearby = true;
          if(b === "Water Tower" && Math.abs(dx)+Math.abs(dy) <= range) waterNearby = true;
        }
      }
    }
    return powerNearby && waterNearby;
  }

  // Calculate income every minute
  function calculateIncome(){
    let income = 0;
    cityGrid.forEach((tile) => {
      if(tile){
        const building = buildingsData[tile.buildingIndex];
        income += building.income[tile.level -1];
      }
    });
    return income;
  }

  // Update UI elements
  function updateUI(){
    moneySpan.textContent = money.toFixed(0);
    population = calculatePopulation();
    populationSpan.textContent = population;
    paycheckSpan.textContent = paycheckTimer;
  }

  // Render grid tiles with emojis and levels
  function renderGrid(){
    const tiles = gridDiv.children;
    for(let y=0; y<gridSize; y++){
      for(let x=0; x<gridSize; x++){
        const index = y*gridSize + x;
        const tile = tiles[index];
        const data = cityGrid[index];
        if(x >= unlockedSize || y >= unlockedSize){
          tile.textContent = "";
          tile.classList.add("locked");
          tile.title = "Locked plot - Buy to unlock for $5000";
        } else {
          tile.classList.remove("locked");
          if(data){
            const building = buildingsData[data.buildingIndex];
            tile.textContent = building.emoji + (data.level > 1 ? data.level : "");
            tile.title = `${building.name} (Level ${data.level})`;
          } else {
            tile.textContent = "";
            tile.title = "";
          }
        }
      }
    }
  }

  // Paycheck timer countdown and income addition every 60s
  function paycheckTick(){
    paycheckTimer--;
    if(paycheckTimer <= 0){
      const income = calculateIncome();
      money += income;
      paycheckTimer = 60;
      updateUI();
    } else {
      updateUI();
    }
  }

  // Earnings popup
  function showEarnings(){
    earningsList.innerHTML = "";
    cityGrid.forEach((tile) => {
      if(tile){
        const b = buildingsData[tile.buildingIndex];
        const inc = b.income[tile.level-1];
        const name = b.name;
        const level = tile.level;
        const li = document.createElement("li");
        li.textContent = `${name} (Level ${level}): $${inc}/min`;
        earningsList.appendChild(li);
      }
    });
    earningsPopup.style.display = "flex";
  }
  function closeEarnings(){
    earningsPopup.style.display = "none";
  }

  // Button handlers
  deleteBtn.onclick = () => {
    deleteMode = !deleteMode;
    deleteBtn.style.backgroundColor = deleteMode ? "#faa" : "";
  };
  earningsBtn.onclick = () => {
    showEarnings();
  };
  upgradeRangeBtn.onclick = () => {
    if(rangeUpgradeLevel >= 3){
      alert("Range is already max level.");
      return;
    }
    const cost = rangeUpgradeLevel === 1 ? 500 : 1000;
    if(money >= cost){
      money -= cost;
      rangeUpgradeLevel++;
      alert(`Range upgraded to level ${rangeUpgradeLevel}.`);
      updateUI();
    } else {
      alert("Not enough money to upgrade range.");
    }
  };

  buildingSelect.onchange = () => {
    selectedBuilding = buildingSelect.value;
    if(selectedBuilding !== ""){
      deleteMode = false;
      deleteBtn.style.backgroundColor = "";
    }
  };

  // Initialize
  createGrid();
  populateBuildingSelect();
  updateUI();
  renderGrid();

  // Paycheck timer interval
  setInterval(paycheckTick, 1000);
</script>

</body>
</html>
